# Gateway

## TODO
контрмеры по рискам.

1) Эскалация прав через заголовки
Ввести валидацию значений X-Internal-Token и X-Admin-Token по конфигу (секреты/список валидных токенов), а лучше — подписывать их (например, HMAC) и проверять подпись, чтобы нельзя было подделать заголовок только по имени.

Добавить проверку происхождения: для внутренних вызовов — whitelist сетей/MTLS; для админ-бота — проверять соответствие токена/role в backend перед присвоением client_type.

Логировать и алертить все запросы, получившие client_type ≠ public, чтобы быстро обнаруживать злоупотребления.

2) Незаверенные заголовки проксируются в backend без фильтрации
В proxy_request очищать чувствительные входящие заголовки: явно удалять Authorization, X-Internal-Token, X-Admin-Token, X-TG-Init-Data, X-TG-User перед отправкой в backend, и затем добавлять/заменять только доверенные (например, X-TG-ID/X-TG-USERNAME) из request.state.identity.

Ввести allowlist заголовков, которые разрешено прокидывать, и дропать всё остальное пользовательское (defense in depth). Для внутренних токенов лучше добавлять их на стороне gateway из конфигурации, а не принимать от клиента.

На backend стороне ввести проверку источника для внутренних операций (дополнительный слой валидации токенов, даже если попадут внешние).

3) Массовый флуд при сбое Redis или через webhook
Сделать rate-limit fail-closed: при ошибке Redis возвращать 429 вместо “allow”, либо ввести резервный in-memory limiter с жёсткими лимитами на время деградации.

Включить лимит для Telegram webhook по умолчанию (tg_webhook > 0) и подобрать значения, учитывая допустимую нагрузку.

Добавить общесервисный circuit-breaker/overload protection: защита от слишком больших body, ограничение concurrency и тайм-ауты на стороне gateway.

Для критичных путей (например, /tg/webhook) включить подпись/проверку IP Telegram и быстрый дроп аномальных запросов до тяжелой обработки.

Дополнительно
Зашить чувствительные секреты через переменные окружения/секрет-хранилище, не через заголовки клиента.

Регулярно пересматривать policy.json, чтобы административные маршруты не были доступны неаутентифицированным типам клиентов; добавить проверку на отсутствие client_type (сейчас None трактуется как public) и явны deny при отсутствии валидации.
