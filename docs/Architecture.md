#  Architecture

---

## 1.  ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ

* Python 3.11
* FastAPI โ backend + gateway
* aiogram 3 โ Telegram-ะฑะพั (admin, specialist, client)
* SQLite โ ะพัะฝะพะฒะฝะฐั ะะ (ัััะฝะฐั ััะตะผะฐ + ะผะธะณัะฐัะธะธ ัะบัะธะฟัะพะผ)
* Redis โ ะบะตั ัะปะพัะพะฒ, OTP, FSM, UI-ัะพััะพัะฝะธะต (last_menu)
* SQL-ะทะฐะฟัะพัั ะฒัััะฝัั (`aiosqlite`)
* Pydantic โ ัะพะปัะบะพ ะดะปั API

---

## 2.  ะะทะฐะธะผะพะดะตะนััะฒะธะต ะบะพะผะฟะพะฝะตะฝัะพะฒ

```
Telegram โ NGINX โ /tg/webhook โ gateway โ bot (ะฒัะทะพะฒ ะผะพะดัะปั) โ backend โ SQLite / Redis
```

* ะัะต ะฒัะพะดััะธะต ัะพะตะดะธะฝะตะฝะธั ะธะดัั ัะตัะตะท `gateway`
* `bot.main()` ะฝะต ะทะฐะฟััะบะฐะตััั ะพัะดะตะปัะฝะพ, ะฐ ะฒัะทัะฒะฐะตััั ะบะฐะบ ะฑะธะฑะปะธะพัะตะบะฐ
* `backend` ัะฐะฑะพัะฐะตั ั SQLite ะธ Redis
* `Redis` ะธัะฟะพะปัะทัะตััั ะธ ะฑะพัะพะผ, ะธ backend'ะพะผ, ะฝะพ ั ัะฐะทะฝัะผ ััะพะฒะฝะตะผ ะดะพัััะฟะฐ

---

## 3.  ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั

### 3.1. backend

* FastAPI-ะฟัะธะปะพะถะตะฝะธะต
* ะะฐะฑะพัะฐะตั ั SQLite ะฝะฐะฟััะผัั
* ะัะฟะพะปะฝัะตั:

  * ัะฐัััั ัะปะพัะพะฒ
  * ะฟัะธัะผ ะธ ะทะฐะฟะธัั ะบะปะธะตะฝัะพะฒ
  * ะฒะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั
  * bootstrap-ะธะฝะธัะธะฐะปะธะทะฐัะธั
* ะะพัััะฟ ะบ Redis: ะฟะพะปะฝัะน (FSM, ะบะตั, ะฑะปะพะบะธัะพะฒะบะธ)

### 3.2. gateway

* FastAPI-ะฟัะพะบัะธ
* `/gateway/app/utils/telegram.pyk` โ ัะพัะบะฐ ะฒัะพะดะฐ Telegram
* ะัะพะฒะตัะบะฐ `X-Telegram-Bot-Api-Secret-Token`
* ะฃััะฐะฝะฐะฒะปะธะฒะฐะตั `client_type = internal`
* ะัะทัะฒะฐะตั bot ะบะฐะบ ะผะพะดัะปั (ัะตัะตะท `process_update`)

* ะััะตะฝัะธัะธะบะฐัะธั TG-ะฟะพะปัะทะพะฒะฐัะตะปะตะน (get_or_create + role)
* ะััะธัะพะฒะฐะฝะธะต user context ะฒ Redis (TTL 10 ะผะธะฝ)
* Rate limiting ะฟะพ tg_id (ะฝะฐัััะฐะธะฒะฐะตััั ะฒ middleware/rate_limit.py)
* ะะตัะตะดะฐัะฐ TgUserContext ะฒ bot

### 3.3. bot (Telegram)

* aiogram 3 FSM-ะฑะพั
* ะะพะดะดะตัะถะธะฒะฐะตั ัะพะปะธ: `admin`, `specialist`, `client`
* FSM โ ัะพะปัะบะพ ะดะปั ัะปะพะถะฝัั ััะตะฝะฐัะธะตะฒ (ะฝะต ะดะปั ะฝะฐะฒะธะณะฐัะธะธ)
* ะัะฟะพะปัะทัะตั Redis:

  * FSM ัะพััะพัะฝะธั
  * OTP ะบะพะดั
  * `last_menu_message_id`
* ะะฐะฑะพัะฐะตั ัะพะปัะบะพ ัะตัะตะท backend API
* ะะต ะธะผะตะตั ะดะพัััะฟะฐ ะบ SQLite

### 3.4. Redis

* ะัะฟะพะปัะทัะตััั ะบะฐะบ shared runtime layer
* ะะปััะธ:

  * `otp:*`, `attempts:*`
  * `fsm:*`, `last_menu:*`
  * `slots:*`, `locks:*`
* bot: ะดะพัััะฟ ัะพะปัะบะพ ะบ FSM, OTP, menu
* backend: ะฟะพะปะฝัะน ะดะพัััะฟ


* `fsm:*` โ FSM (ะฑะธะทะฝะตั-ััะตะฝะฐัะธะธ)
* `last_menu:*` โ UI-ัะพััะพัะฝะธะต ะฑะพัะฐ (ะพัะธััะบะฐ ัะฐัะฐ)


### 3.5. SQLite

* ะฅัะฐะฝะธััั ะฒ `data/sqlite/booking.db`
* ะกัะตะผะฐ: `schema_sqlite.sql`, ะผะธะณัะฐัะธะธ โ `scripts/migrate.py`
* ะัะฟะพะปัะทัะตััั **ัะพะปัะบะพ backend**
* `SELECT FOR UPDATE` โ ะดะปั ะฑะปะพะบะธัะพะฒะบะธ ะฟัะธ ะทะฐะฟะธัะธ

---

## 4.  Telegram-ะฑะพั: ัะพะปะธ

| ะะพะปั       | ะะฐะทะฝะฐัะตะฝะธะต                          | API | Redis | SQLite |
| ---------- | ----------------------------------- | --- | ----- | ------ |
| Admin      | ะฃะฟัะฐะฒะปะตะฝะธะต ะฒัะตะน ัะธััะตะผะพะน            | โ   | โ     | โ      |
| Specialist | ะัะพัะผะพัั ะปะธัะฝัั ะทะฐะฟะธัะตะน, ัะฐัะฟะธัะฐะฝะธั | โ   | โ     | โ      |
| Client     | ะะฐะฟะธัั, ะฟัะพัะผะพัั, ะพัะผะตะฝะฐ            | โ   | โ     | โ      |

* ะัะต ัะพะปะธ ัะฐะฑะพัะฐัั ัะพะปัะบะพ ัะตัะตะท API backend
* ะัะต ะพะณัะฐะฝะธัะตะฝะธั ะฟะพ ะดะพัััะฟั ะพะฟัะตะดะตะปััััั backend'ะพะผ

---

## 5. ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```plaintext
.
โโโ backend  # ะะธะทะฝะตั ะปะพะณะธะบะฐ, ัะฟัะฐะฒะพัะฝะธะบะธ
โยย โโโ app
โยย โยย โโโ models
โยย โยย โโโ redis_client.py
โยย โยย โโโ routers
โยย โยย โโโ schemas
โยย โยย โโโ services
โยย โโโ Dockerfile
โยย โโโ migrate.py
โยย โโโ migrations
โโโ bot                         # UI - ะฒัะทัะฒะฐะตััั gateway 
โยย โโโ app
โยย โยย โโโ handlers            # reply / inline handlers (router)
โยย โยย โโโ flows               # FSM ััะตะฝะฐัะธะธ
โยย โยย โยย โโโ admin
โยย โยย โยย โโโ client
โยย โยย โยย โโโ specialist
โยย โยย โโโ i18n
โยย โยย โโโ keyboards
โยย โยย โโโ utils
โยย โโโ Dockerfile
โโโ data                        # SQLite
โยย โโโ sqlite
โโโ docker-compose.yml
โโโ docs
โโโ gateway                     # webhook + ะฒัะทะพะฒ ะฑะพัะฐ
โยย โโโ app
โยย โยย โโโ middleware
โยย โยย โโโ policy
โยย โยย โโโ proxy.py
โยย โยย โโโ redis_client.py
โยย โยย โโโ utils
โยย โยย     โโโ telegram.py
โยย โโโ Dockerfile
โโโ README.md
โโโ requirements.txt
โโโ schema
โโโ scripts                     # bootstrap, ะผะธะณัะฐัะธะธ
โโโ .env

```

---

## 6.  ะะฝะธัะธะฐะปะธะทะฐัะธั ะธ ะดะพัััะฟ ะฐะดะผะธะฝะธัััะฐัะพัะฐ

* ะกะบัะธะฟั `init_admin.py` ะฒัะฟะพะปะฝัะตััั ะพะดะธะฝ ัะฐะท
* ะััะผะพะน ะดะพัััะฟ ะบ SQLite ะตััั **ัะพะปัะบะพ ั ัะบัะธะฟัะฐ** ะธ backend
* ะะพัะปะต ะธะฝะธัะธะฐะปะธะทะฐัะธะธ:

  * `tg_id` ะฐะดะผะธะฝะธัััะฐัะพัะฐ ัะพััะฐะฝัะฝ ะฒ ะะ
  * bot/admin ัะฐะฑะพัะฐะตั ัะพะปัะบะพ ัะตัะตะท API
  * backend ะดะพะฟััะบะฐะตั ัะพะปัะบะพ ะฐะฒัะพัะธะทะพะฒะฐะฝะฝัั `tg_id`

---

## 7.  ะัะตะธะผััะตััะฒะฐ Gateway-centric ะฐััะธัะตะบัััั

| ะัะฟะตะบั             | Gateway-centric                      |
| ------------------ | ------------------------------------ |
| ะะดะธะฝะฐั ัะพัะบะฐ ะฒัะพะดะฐ | โ ะัั ัะตัะตะท gateway                  |
| Rate limiting      | โ ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัะน ะบะพะฝััะพะปั          |
| Access policy      | โ ะะฑัะฐั ะฟะพะปะธัะธะบะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ        |
| Audit log          | โ ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัะน ะปะพะณ               |
| SSL/TLS            | โ ะขะพะปัะบะพ ะฝะฐ nginx                    |
| ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต    | โ ะะฝะพะณะพะบะปะธะตะฝัะฝะพััั ัะตัะตะท ะบะพะฝัะธะณ      |
| ะะตัะบะพะปัะบะพ ะบะปะธะตะฝัะพะฒ | โ tg_client, public

ะะพั โ ัะธัััะน UI-ัะปะพะน, gateway โ ะตะดะธะฝะฐั ัะพัะบะฐ ะบะพะฝััะพะปั.

---

