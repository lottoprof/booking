# UI‑контракт клавиатуры Telegram‑бота (Reply / Inline)

> **Источник истины** для всей логики меню и навигации.
> Любые изменения в коде **обязаны** соответствовать этому документу.

---

## 1. Цели контракта

Контракт фиксирует правила работы с клавиатурами Telegram так, чтобы:

* ReplyKeyboard **не схлопывалась** на Android
* системная клавиатура **не появлялась самопроизвольно**
* чат оставался **минимально чистым**
* поведение было **детерминированным** и воспроизводимым
* Inline‑сценарии не ломали меню

---

## 2. Термины

| Термин                   | Описание                                                                            |
| ------------------------ | ----------------------------------------------------------------------------------- |
| **ReplyKeyboard**        | Клавиатура ввода Telegram (внизу экрана)                                            |
| **InlineKeyboard**       | Кнопки под сообщением (callback)                                                    |
| **ZWS**                  | `\u200b` (ZERO WIDTH SPACE) — технический непустой текст                            |
| **Якорь меню**           | Единственное bot‑сообщение, которое Telegram может считать источником ReplyKeyboard |
| **last_menu_message_id** | `message_id` якоря меню для конкретного чата                                        |

---

## 3. Базовые инварианты (НЕ НАРУШАЮТСЯ НИКОГДА)

1. В одном чате **ровно один** потенциальный якорь ReplyKeyboard.
2. В режиме Reply → Reply **сообщение пользователя НЕ удаляется**.
3. ReplyKeyboard отправляется **только** с **непустым текстом** (ZWS).
4. Удаляется **только** предыдущий якорь меню (один, не «через одно»).
5. Удаление якоря происходит **ДО** отправки нового меню.
6. `ReplyKeyboardRemove` **запрещён** между меню.
7. Inline‑сообщения **никогда** не обновляют `last_menu_message_id`.

Нарушение любого пункта = риск:

* исчезновения ReplyKeyboard
* появления системной клавиатуры Android

---

## 4. Режимы работы UI

### 4.1 Type A — Reply → Reply (основная навигация)

**Назначение:**

* главное меню
* админ‑панель
* навигация между разделами

**Алгоритм:**

```text
old = last_menu_message_id
if old:
    delete(old)

msg = send_message(
    text = ZWS,
    reply_markup = ReplyKeyboard
)

last_menu_message_id = msg.id
```

**Запрещено:**

* удалять сообщение пользователя
* отправлять пустой текст
* использовать ReplyKeyboardRemove
* удалять больше одного bot‑сообщения

**Гарантии:**

* Android не поднимает системную клавиатуру
* ReplyKeyboard остаётся активной
* чат содержит максимум 1 bot‑меню

---

### 4.2 Type B — Reply → Inline (вход в сценарий)

**Назначение:**

* подтверждения
* выбор параметров
* сценарии с callback

**Алгоритм:**

```text
(optional) delete(user message)
delete(last_menu_message_id)

send_message(
    text,
    reply_markup = InlineKeyboard
)

last_menu_message_id = null
```

**Разрешено:**

* удалять сообщение пользователя

**Запрещено:**

* использовать ReplyKeyboard
* сохранять якорь меню

---

### 4.3 Type C — Reply → Reply без очистки (пошаговые сценарии)

**Назначение:**

* мастера
* формы
* редкие подтверждённые цепочки

**Алгоритм:**

```text
send_message(text, ReplyKeyboard)
update last_menu_message_id (если требуется)
```

⚠ **Ограничения:**

* НЕ использовать для навигации
* НЕ использовать для админ‑меню

---

## 5. Inline‑режим (всегда сценарий)

Inline **НЕ является меню**.

### 5.1 Inline → Inline

* обновление через `editMessageText`
* ReplyKeyboard не участвует

### 5.2 Inline → Reply (возврат в меню)

**Единственный допустимый путь:**

```text
delete(inline message)
call Type A (Reply → Reply)
```

Запрещено:

* напрямую вызывать Reply‑методы из callback

---

## 6. Хранилище состояния

Используется Redis.

```text
key: tg:last_menu:{chat_id}
value: <message_id>
type: string
ttl: отсутствует
```

* один чат = один ключ
* одно значение, не список

---

## 7. Почему чат остаётся чистым

В режиме Type A:

```text
[ User: нажал кнопку ]
[ Bot: ZWS + новое меню ]
```

* старое bot‑меню удалено
* user‑сообщение остаётся (1 шт.)
* ReplyKeyboard стабильна

Это **минимально возможная чистота**, совместимая с Android.

---

## 8. Строгие запреты (архитектурные)

Бот **никогда не должен**:

* удалять user‑сообщение в Type A
* удалять bot‑сообщения «через одно»
* хранить несколько якорей меню
* смешивать Reply и Inline в одном сообщении
* использовать ReplyKeyboardRemove между меню

---

## 9. Проверка соблюдения контракта

Любой новый код должен проверяться по вопросам:

1. В каком режиме я работаю (A / B / C / Inline)?
2. Удаляю ли я user‑сообщение?
3. Сколько bot‑сообщений я удаляю?
4. Использую ли ZWS там, где требуется?
5. Не трогаю ли Redis‑якорь из Inline?

Если есть сомнение — **код считается неверным**.

---

## 10. Статус

Любые изменения возможны **только** через обновление этого документа.

