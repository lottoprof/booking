# Система записи

## Оглавление

* [Введение](#введение)
* [Архитектура](#архитектура)
* [Установка](#установка)
* [Веб-интерфейсы](#веб-интерфейсы)
  * [Админ-панель](#админ-панель)
  * [Пользовательский сайт](#пользовательский-сайт)
  * [Telegram-бот и Mini App](#telegram-бот-и-mini-app)
* [Backend и API](#backend-и-api)
* [Работа с клиентами](#работа-с-клиентами)
* [Финансы и CRM](#финансы-и-crm)
* [Примеры использования](#примеры-использования)
  * [Базовый пример](#базовый-пример)
  * [Продвинутый пример](#продвинутый-пример)
* [Дальнейшие планы](#дальнейшие-планы)
* [Процесс бронирования](#процесс-бронирования)
* [Структура базы данных](#структура-базы-данных)
* [Runtime расчёт слотов](#runtime-расчёт-слотов)
* [Механика пересчёта при изменениях](#механика-пересчёта-при-изменениях)

---

## Введение

**Система записи** — комплексное решение для организаций, работающих по предварительной записи.
Единые каналы работы:

* Админ‑панель
* Клиентский сайт (Vue)
* Telegram Mini App (единый бот c маршрутизацией по ролям)

Основой является **дискретная сетка 15 минут** и **Redis‑движок для быстрого расчёта слотов и конкуренции**.

---

## Архитектура

**PostgreSQL** — источник истины.
**Redis** — слоты, блокировки, уведомления.
**Vue.js** — клиентская запись.
**Telegram Mini App** — интерфейсы клиент/специалист/админ.

<details>
<summary>Нажмите, чтобы увидеть подробности</summary>

| Данные              | Где хранить   | Назначение           |
| ------------------- | ------------- | -------------------- |
| Справочники         | PostgreSQL    | Истина               |
| Услуги, специалисты | PostgreSQL    | Истина               |
| Графики (JSON)      | PostgreSQL    | Истина               |
| Runtime‑слоты       | Redis         | Быстрый доступ       |
| Блокировки слотов   | Redis         | Предотвращение гонок |
| Уведомления         | Redis Pub/Sub | Событийность         |

---

</details>


## Установка

<details>
<summary>Нажмите, чтобы увидеть подробности</summary>

1. PostgreSQL + Redis
2. Настройка переменных окружения
3. Применение миграций
4. Запуск backend и frontend

---
</details>


## Веб-интерфейсы

### Админ‑панель Telegram

* управление объектами, комнатами, услугами;
* создание override;
* графики специалистов;
* сложные брони.

### Клиентский сайт (Vue)

* выбор услуги/специалиста;
* быстрый просмотр слотов на 60 дней;
* онлайн‑запись.

### Telegram Mini App

* единый бот;
* маршрутизация по ролям;
* клиент: запись/отмена;
* специалист: расписание/блокировки;
* админ: управление сущностями.

---

## Backend и API

* FastAPI
* SQLite/PostgreSQL
* Redis
* Авторизация (password/tg)
* API для Vue и Telegram Mini App

---

## Работа с клиентами

* users — единая сущность (client/specialist/admin)
* хранение tg_id, tg_username, телефона, email
* персональные скидки (`client_discounts`)
* пакеты (`client_packages`)
* автоматические уведомления

---

## Финансы и CRM

* `client_wallets` — баланс клиента
* `wallet_transactions` — операции (deposit/payment/refund)
* связь транзакций с `bookings`

---

## Примеры использования

<details>
<summary>Нажмите, чтобы увидеть подробности</summary>

### Базовый пример

1. Клиент выбирает услугу
2. Система отдаёт слоты (60 дней)
3. Клиент бронирует
4. Уведомления отправляются

### Продвинутый пример

1. Клиент покупает пакет услуг
2. При записи уменьшается остаток пакета
3. Система автоматически применяет скидки

---

</details>

## Дальнейшие планы

<details>
<summary>Нажмите, чтобы увидеть подробности</summary>

* визуальный редактор расписаний
* аналитика загрузки
* интеграции с внешними календарями
* автоматизация напоминаний

---

</details>

## Процесс бронирования

<details>
<summary>Нажмите, чтобы увидеть подробности</summary>

### Диаграмма

```mermaid
sequenceDiagram
    participant C as Клиент
    participant API as FastAPI
    participant R as Redis
    participant DB as SQLite

    C->>API: GET /slots/calendar
    API->>R: Level 1 (базовая сетка)
    API->>DB: Level 2 (спецы + bookings)
    API-->>C: Доступные дни

    C->>API: GET /slots/day
    API->>DB: Level 2 детальный
    API-->>C: Слоты + специалисты

    C->>API: POST /bookings
    API->>R: LOCK
    API->>DB: Double-check Level 2
    alt занят
        API-->>C: 409 Conflict
    else
        API->>DB: INSERT booking
        API-->>C: 201 Created
    end
    API->>R: UNLOCK
```
---

</details>

## Структура базы данных

<details>
<summary>Нажмите, чтобы увидеть подробности</summary>

### Users (универсальная сущность)

* клиенты, специалисты, админы — все в одной таблице `users`;
* роли через `user_roles`;
* tg_id, tg_username, phone, email;
* birth_date, gender, notes.

### Основные таблицы

* `company` — единая компания;
* `locations` — включая `work_schedule JSONB`;
* `rooms`;
* `services` (duration, break, price);
* `service_rooms`;
* `service_packages` — **JSON-состав пакета**;
* `specialists` — `work_schedule JSONB`;
* `specialist_services`;
* `calendar_overrides`;
* `bookings` — с duration+break, фиксируемыми при создании;
* `booking_discounts`;
* `client_packages`;
* `client_discounts`;
* `client_wallets`;
* `wallet_transactions`;
* `push_subscriptions`.

### Пример JSON-графика (локация или специалист)

```
{
  "0": [["09:00","18:00"]],
  "1": [["09:00","12:00"],["14:00","20:00"]],
  "6": []
}
```

---

</details>

# Runtime расчёт слотов

<details>
<summary>Нажмите, чтобы увидеть подробности</summary>

## Двухуровневая архитектура

Система использует двухуровневый расчёт слотов.

### Level 1: Базовая сетка (Redis)

**Что содержит:**
* work_schedule локации
* calendar_overrides локации
* min_advance_hours

**Что НЕ содержит:**
* Bookings
* Специалистов
* Комнаты

**Redis-ключ:** `slots:location:{location_id}:{date}`

**Формат:** строка 96 символов "0"/"1" (шаг 15 минут)

**Назначение:** "Локация РАБОТАЕТ или НЕТ"

### Level 2: Гранулярный расчёт (на лету)

Выполняется после выбора услуги клиентом:

1. получить базовую сетку (Level 1);
2. применить графики специалистов услуги;
3. применить calendar_overrides специалистов;
4. применить bookings специалистов;
5. если service_rooms не пусто — проверить комнаты;
6. применить bookings комнат.

**Назначение:** "Кто свободен для ЭТОЙ услуги?"

### Конфигурация
```python
horizon_days: int = 60        # 30 / 60 / 90
min_advance_hours: int = 6    # 1 / 6 / 12 / 24
slot_step_min: int = 15       # фиксированный
```
---

</details>

# Механика пересчёта при изменениях

<details>
<summary>Нажмите, чтобы увидеть подробности</summary>

## Инвалидация кеша (Level 1)

| Событие | Инвалидация |
|---------|-------------|
| Изменение work_schedule локации | ✅ Да, horizon_days |
| Создание/удаление override локации | ✅ Да, affected dates |
| Изменение графика специалиста | ❌ Нет (Level 2) |
| Создание/отмена booking | ❌ Нет (Level 2) |

## Redis-lock в процессе бронирования
```
1. Клиент выбирает услугу
2. API рассчитывает Level 2 (спецы + комнаты + bookings)
3. Клиент выбирает слот
4. API → Redis: LOCK(location:date)
5. API повторно проверяет Level 2 (double-check)
6. Создаёт запись в bookings
7. Назначает room_id (первая свободная)
8. Освобождает LOCK
```

Grid в Redis НЕ обновляется — bookings проверяются на лету.

## Инвалидация кеша

Выполняется callback-функцией `invalidate_location_cache()` при изменении:
* work_schedule локации
* calendar_overrides локации
