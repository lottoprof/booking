<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ĞĞ½Ğ»Ğ°Ğ¹Ğ½ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ â€” UPGRADE</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style"
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&family=Manrope:wght@300;400;500;600;700&display=swap"
        onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </noscript>

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN TOKENS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --teal:        #2BB5B8;
      --teal-light:  #5DD3D5;
      --teal-dark:   #1E8E90;
      --teal-subtle: #E8F7F7;
      --font-display:'Cormorant Garamond', Georgia, serif;
      --font-body:   'Manrope', system-ui, sans-serif;

      /* Telegram theme integration with UPGRADE fallbacks */
      --bg:          var(--tg-theme-bg-color, #FFFFFF);
      --bg-secondary:var(--tg-theme-secondary-bg-color, #F4F8F8);
      --text:        var(--tg-theme-text-color, #1A2B2B);
      --text-hint:   var(--tg-theme-hint-color, #6B8080);
      --accent:      var(--tg-theme-button-color, #2BB5B8);
      --accent-text: var(--tg-theme-button-text-color, #FFFFFF);
      --link:        var(--tg-theme-link-color, #1E8E90);

      /* Extended palette â€” auto-adapts via TG vars */
      --text-strong:   var(--tg-theme-text-color, #0F1E1E);
      --border:        var(--tg-theme-secondary-bg-color, #DAE5E5);
      --border-active: var(--teal);
      --card-bg:       var(--tg-theme-bg-color, #FFFFFF);
      --card-hover:    var(--tg-theme-secondary-bg-color, #F0F6F6);
      --danger:        #DC3545;
      --success:       #22C55E;
      --success-bg:    #DCFCE7;
      --danger-bg:     #FEE2E2;

      --shadow-sm:   0 1px 3px rgba(0,0,0,0.06);
      --shadow-md:   0 4px 16px rgba(0,0,0,0.08);
      --radius:      14px;
      --radius-sm:   10px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESET & BASE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      font-weight: 400;
    }

    .hidden { display: none !important; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LAYOUT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 32px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROGRESS BAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .progress-bar {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
    }
    .progress-step {
      flex: 1;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      transition: background 0.3s;
    }
    .progress-step.completed { background: var(--teal); }
    .progress-step.active    { background: var(--teal); opacity: 0.6; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP TRANSITIONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .step {
      display: none;
      animation: stepIn 0.25s ease;
    }
    .step.active { display: block; }

    @keyframes stepIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .step-title {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-strong);
      margin-bottom: 4px;
    }
    .step-subtitle {
      font-size: 0.85rem;
      color: var(--text-hint);
      margin-bottom: 16px;
      font-weight: 400;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SERVICE CARDS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .services-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .service-card {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--card-bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .service-card:active { transform: scale(0.98); }
    .service-card.selected {
      border-color: var(--teal);
      background: var(--teal-subtle);
      box-shadow: 0 0 0 1px var(--teal);
    }

    .service-card-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    .service-card.selected .service-card-icon {
      background: rgba(43,181,184,0.15);
    }

    .service-card-body { flex: 1; min-width: 0; }

    .service-card-name {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--text-strong);
      line-height: 1.3;
    }
    .service-card-desc {
      font-size: 0.82rem;
      color: var(--text-hint);
      font-weight: 400;
      margin-top: 1px;
      line-height: 1.35;
    }
    .service-card-meta {
      font-size: 0.78rem;
      color: var(--text-hint);
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .service-card-meta .dot {
      width: 3px; height: 3px;
      border-radius: 50%;
      background: var(--text-hint);
      opacity: 0.5;
    }

    .service-card-price {
      font-weight: 700;
      font-size: 1rem;
      color: var(--teal-dark);
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CALENDAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .calendar-month {
      font-family: var(--font-display);
      font-weight: 600;
      font-size: 1.15rem;
      color: var(--text-strong);
    }
    .calendar-nav {
      display: flex;
      gap: 6px;
    }
    .calendar-nav button {
      width: 36px; height: 36px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      color: var(--text-strong);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .calendar-nav button:active { background: var(--teal-subtle); border-color: var(--teal); }
    .calendar-nav button:disabled { opacity: 0.3; cursor: not-allowed; }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--text-hint);
      padding: 6px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .calendar-day {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      font-size: 0.88rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      color: var(--text);
    }
    .calendar-day.empty { cursor: default; }
    .calendar-day.available {
      background: var(--card-bg);
      border: 1.5px solid var(--border);
    }
    .calendar-day.available:active {
      border-color: var(--teal);
      background: var(--teal-subtle);
    }
    .calendar-day.unavailable {
      color: var(--border);
      cursor: not-allowed;
    }
    .calendar-day.selected {
      background: var(--teal);
      color: #fff;
      font-weight: 700;
      border-color: var(--teal);
    }
    .calendar-day.today {
      font-weight: 700;
      color: var(--teal-dark);
    }
    .calendar-day.today.selected {
      color: #fff;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TIME SLOTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .time-group { margin-bottom: 16px; }
    .time-group-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-hint);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
      padding-left: 2px;
    }
    .time-slots-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    @media (max-width: 360px) {
      .time-slots-grid { grid-template-columns: repeat(3, 1fr); }
    }
    .time-slot {
      padding: 12px 6px;
      text-align: center;
      background: var(--card-bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
      font-size: 0.88rem;
      font-weight: 500;
      color: var(--text-strong);
      -webkit-tap-highlight-color: transparent;
    }
    .time-slot:active {
      border-color: var(--teal);
      background: var(--teal-subtle);
    }
    .time-slot.selected {
      background: var(--teal);
      color: #fff;
      border-color: var(--teal);
      font-weight: 700;
    }
    .no-slots {
      text-align: center;
      padding: 40px 16px;
      color: var(--text-hint);
      font-size: 0.9rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SPECIALIST CARDS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .specialists-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .specialist-card {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--card-bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .specialist-card:active { transform: scale(0.98); }
    .specialist-card.selected {
      border-color: var(--teal);
      background: var(--teal-subtle);
      box-shadow: 0 0 0 1px var(--teal);
    }

    .specialist-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
      color: var(--text-hint);
      font-weight: 600;
      overflow: hidden;
    }
    .specialist-avatar img {
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .specialist-body { flex: 1; min-width: 0; }
    .specialist-name {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--text-strong);
    }
    .specialist-role {
      font-size: 0.78rem;
      color: var(--text-hint);
      margin-top: 2px;
    }

    .specialist-check {
      width: 24px; height: 24px;
      border-radius: 50%;
      border: 1.5px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      font-size: 0.75rem;
      color: transparent;
    }
    .specialist-card.selected .specialist-check {
      background: var(--teal);
      border-color: var(--teal);
      color: #fff;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONFIRMATION CARD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .confirm-card {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    .confirm-card-title {
      font-family: var(--font-display);
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--text-strong);
      margin-bottom: 14px;
    }
    .confirm-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.88rem;
    }
    .confirm-row:last-child { border-bottom: none; }
    .confirm-label {
      color: var(--text-hint);
      font-weight: 400;
      flex-shrink: 0;
    }
    .confirm-value {
      font-weight: 600;
      color: var(--text-strong);
      text-align: right;
      margin-left: 12px;
    }

    .confirm-btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: var(--radius);
      background: var(--teal);
      color: #fff;
      font-family: var(--font-body);
      font-size: 0.92rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 16px rgba(43,181,184,0.25);
      -webkit-tap-highlight-color: transparent;
    }
    .confirm-btn:active {
      transform: scale(0.98);
      background: var(--teal-dark);
    }
    .confirm-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATUS SCREENS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .status-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 40px 16px;
    }
    .status-icon {
      width: 64px; height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      font-size: 28px;
    }
    .status-icon.pending {
      border: 3px solid var(--border);
      border-top-color: var(--teal);
      animation: spin 0.8s linear infinite;
    }
    .status-icon.success { background: var(--success-bg); color: var(--success); }
    .status-icon.error   { background: var(--danger-bg); color: var(--danger); }

    @keyframes spin { to { transform: rotate(360deg); } }

    .status-title {
      font-family: var(--font-display);
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-strong);
      margin-bottom: 6px;
    }
    .status-text {
      font-size: 0.85rem;
      color: var(--text-hint);
      margin-bottom: 20px;
    }

    /* Summary after success */
    .summary-card {
      width: 100%;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 16px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 9px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .summary-row:last-child { border-bottom: none; }
    .summary-label { color: var(--text-hint); }
    .summary-value { font-weight: 600; color: var(--text-strong); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SKELETONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .skeleton-list { display: flex; flex-direction: column; gap: 10px; }

    .skeleton-card {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--card-bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
    }
    .skeleton-icon {
      width: 44px; height: 44px;
      border-radius: 12px;
      background: var(--bg-secondary);
    }
    .skeleton-lines { flex: 1; }
    .skeleton-line {
      height: 12px;
      border-radius: 6px;
      background: var(--bg-secondary);
      margin-bottom: 6px;
    }
    .skeleton-line:last-child { margin-bottom: 0; }
    .skeleton-line.w60 { width: 60%; }
    .skeleton-line.w40 { width: 40%; }
    .skeleton-line.w80 { width: 80%; }
    .skeleton-price {
      width: 56px; height: 18px;
      border-radius: 6px;
      background: var(--bg-secondary);
      flex-shrink: 0;
    }

    .skeleton-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .skeleton-slot {
      height: 44px;
      border-radius: var(--radius-sm);
      background: var(--bg-secondary);
    }

    /* Shimmer animation */
    .skeleton-shimmer {
      position: relative;
      overflow: hidden;
    }
    .skeleton-shimmer::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(43,181,184,0.04) 40%,
        rgba(43,181,184,0.08) 50%,
        rgba(43,181,184,0.04) 60%,
        transparent 100%
      );
      animation: shimmer 1.6s ease-in-out infinite;
    }
    @keyframes shimmer {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADING & ERROR SCREENS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }
    .loading-text {
      font-size: 0.85rem;
      color: var(--text-hint);
    }

    .error-screen {
      text-align: center;
      padding: 48px 16px;
    }
    .error-screen p:first-child {
      font-family: var(--font-display);
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-strong);
      margin-bottom: 8px;
    }
    .error-screen .hint {
      font-size: 0.85rem;
      color: var(--text-hint);
      margin-bottom: 20px;
    }
    .error-retry {
      display: inline-flex;
      padding: 10px 24px;
      border: 1.5px solid var(--teal);
      border-radius: 100px;
      background: transparent;
      color: var(--teal);
      font-family: var(--font-body);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .error-retry:active {
      background: var(--teal);
      color: #fff;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SWIPE TRANSITION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .calendar-swipe {
      transition: transform 0.25s ease, opacity 0.25s ease;
    }
    .calendar-swipe.swipe-left {
      transform: translateX(-30px);
      opacity: 0;
    }
    .calendar-swipe.swipe-right {
      transform: translateX(30px);
      opacity: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PHONE TOAST
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .phone-toast {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      animation: toastFadeIn 0.25s ease;
    }
    .phone-toast.fade-out {
      animation: toastFadeOut 0.25s ease forwards;
    }
    .phone-toast-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 28px 24px;
      max-width: 320px;
      text-align: center;
      box-shadow: var(--shadow-md);
    }
    .phone-toast-icon {
      font-size: 2rem;
      margin-bottom: 12px;
    }
    .phone-toast-text {
      font-size: 0.92rem;
      color: var(--text-strong);
      font-weight: 500;
      line-height: 1.45;
    }
    @keyframes toastFadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    @keyframes toastFadeOut {
      from { opacity: 1; }
      to   { opacity: 0; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.1s !important;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="miniapp">

    <!-- Loading State -->
    <div id="loading-screen" class="loading-screen">
      <div class="spinner"></div>
      <span class="loading-text">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</span>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">

      <div class="progress-bar" id="progress-bar"></div>

      <!-- Step 1: Service -->
      <div id="step-service" class="step">
        <h1 class="step-title">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑƒÑĞ»ÑƒĞ³Ñƒ</h1>
        <p class="step-subtitle">Ğ¦ĞµĞ½Ñ‹ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ğ·Ğ° Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾ÑĞµÑ‰ĞµĞ½Ğ¸Ğµ</p>
        <div id="services-list" class="services-list"></div>
        <div id="services-skeleton" class="skeleton-list hidden">
          <div class="skeleton-card skeleton-shimmer">
            <div class="skeleton-icon"></div>
            <div class="skeleton-lines"><div class="skeleton-line w80"></div><div class="skeleton-line w40"></div></div>
            <div class="skeleton-price"></div>
          </div>
          <div class="skeleton-card skeleton-shimmer">
            <div class="skeleton-icon"></div>
            <div class="skeleton-lines"><div class="skeleton-line w60"></div><div class="skeleton-line w40"></div></div>
            <div class="skeleton-price"></div>
          </div>
          <div class="skeleton-card skeleton-shimmer">
            <div class="skeleton-icon"></div>
            <div class="skeleton-lines"><div class="skeleton-line w80"></div><div class="skeleton-line w40"></div></div>
            <div class="skeleton-price"></div>
          </div>
        </div>
      </div>

      <!-- Step 2: Calendar -->
      <div id="step-calendar" class="step">
        <h1 class="step-title">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ</h1>
        <p class="step-subtitle">Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ´Ğ½Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸</p>

        <div class="calendar-header">
          <span class="calendar-month" id="current-month"></span>
          <div class="calendar-nav">
            <button id="prev-month" aria-label="ĞŸÑ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†">&#8249;</button>
            <button id="next-month" aria-label="Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†">&#8250;</button>
          </div>
        </div>

        <div class="calendar-grid" style="margin-bottom: 5px;">
          <div class="calendar-day-header">ĞŸĞ½</div>
          <div class="calendar-day-header">Ğ’Ñ‚</div>
          <div class="calendar-day-header">Ğ¡Ñ€</div>
          <div class="calendar-day-header">Ğ§Ñ‚</div>
          <div class="calendar-day-header">ĞŸÑ‚</div>
          <div class="calendar-day-header">Ğ¡Ğ±</div>
          <div class="calendar-day-header">Ğ’Ñ</div>
        </div>
        <div id="calendar-days" class="calendar-grid"></div>
      </div>

      <!-- Step 3: Time -->
      <div id="step-time" class="step">
        <h1 class="step-title">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ</h1>
        <p class="step-subtitle" id="selected-date-display"></p>
        <div id="time-slots-container"></div>
        <div id="time-skeleton" class="hidden">
          <div class="skeleton-grid skeleton-shimmer">
            <div class="skeleton-slot"></div><div class="skeleton-slot"></div>
            <div class="skeleton-slot"></div><div class="skeleton-slot"></div>
            <div class="skeleton-slot"></div><div class="skeleton-slot"></div>
            <div class="skeleton-slot"></div><div class="skeleton-slot"></div>
          </div>
        </div>
        <div id="no-slots-message" class="no-slots hidden">
          ĞĞµÑ‚ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ñ… ÑĞ»Ğ¾Ñ‚Ğ¾Ğ² Ğ½Ğ° ÑÑ‚Ñƒ Ğ´Ğ°Ñ‚Ñƒ
        </div>
      </div>

      <!-- Step 4: Specialist -->
      <div id="step-specialist" class="step">
        <h1 class="step-title">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ°</h1>
        <p class="step-subtitle" id="specialist-subtitle"></p>
        <div id="specialists-list" class="specialists-list"></div>
      </div>

      <!-- Step 5: Confirm -->
      <div id="step-confirm" class="step">
        <!-- Review before booking -->
        <div id="confirm-review">
          <h1 class="step-title">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ</h1>
          <p class="step-subtitle">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑÂ»</p>

          <div class="confirm-card">
            <div class="confirm-card-title">Ğ’Ğ°ÑˆĞ° Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ</div>
            <div id="confirm-details"></div>
          </div>

          <button class="confirm-btn" id="confirm-btn">Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ</button>
        </div>

        <!-- Pending -->
        <div id="status-pending" class="status-screen hidden">
          <div class="status-icon pending"></div>
          <h2 class="status-title">ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ...</h2>
          <p class="status-text">Ğ­Ñ‚Ğ¾ Ğ·Ğ°Ğ¹Ğ¼Ñ‘Ñ‚ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞµĞºÑƒĞ½Ğ´</p>
        </div>

        <!-- Success -->
        <div id="status-success" class="status-screen hidden">
          <div class="status-icon success">âœ“</div>
          <h2 class="status-title">Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ°!</h2>
          <p class="status-text">ĞœÑ‹ Ğ¿Ñ€Ğ¸ÑˆĞ»Ñ‘Ğ¼ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ</p>
          <div class="summary-card" id="booking-summary"></div>
        </div>

        <!-- Error -->
        <div id="status-error" class="status-screen hidden">
          <div class="status-icon error">âœ•</div>
          <h2 class="status-title">ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ</h2>
          <p class="status-text" id="error-message"></p>
        </div>
      </div>

    </div>

    <!-- Init Error -->
    <div id="error-screen" class="error-screen hidden">
      <p>ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸</p>
      <p class="hint" id="init-error-message">ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</p>
      <button class="error-retry" id="retry-btn">ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°</button>
    </div>

  </div>

  <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MINI APP â€” Telegram WebApp booking
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    class MiniApp {
      constructor() {
        this.tg = window.Telegram.WebApp;
        this.state = {
          locationId: 1,
          clientId: 0,
          hasPhone: false,
          service: null,
          date: '',
          time: '',
          specialistId: null,
          specialistName: '',
        };
        this.services = [];
        this.availableDays = new Map();
        this.timeSlots = [];
        this.specialists = [];
        this.currentMonth = new Date();
        this.currentStep = 'service';
        this.mainButtonCallback = null;
        this.hasMultipleSpecialists = false;

        // Steps order â€” dynamic, specialist step inserted only when needed
        this.steps = ['service', 'calendar', 'time', 'confirm'];

        this.init();
      }

      async init() {
        this.tg.ready();
        this.tg.expand();
        this.tg.BackButton.onClick(() => this.handleBack());

        // Retry button
        document.getElementById('retry-btn')?.addEventListener('click', () => {
          document.getElementById('error-screen').classList.add('hidden');
          document.getElementById('loading-screen').classList.remove('hidden');
          this.init();
        });

        try {
          const [userData, locations, services] = await Promise.all([
            this.verifyUser(),
            this.fetchAPI('/web/locations'),
            this.fetchAPI('/web/services'),
          ]);

          this.state.clientId = userData.client_id;
          if (locations.length > 0) this.state.locationId = locations[0].id;
          this.services = services.map(card => ({
            id: card.service_id || card.variants?.[0]?.package_id || 0,
            service_package_id: card.variants?.[0]?.package_id || null,
            name: card.name,
            description: card.description,
            category: card.category,
            icon: card.icon || 'â—ˆ',
            duration_min: card.duration_min,
            price: card.variants?.[0]?.price || 0,
            variants: card.variants || [],
          }));

          this.hideLoading();
          this.renderProgressBar();
          this.renderServices();
          this.showStep('service');
        } catch (error) {
          console.error('Init error:', error);
          this.showInitError(error.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ');
        }
      }

      /* â”€â”€ API â”€â”€ */

      async fetchAPI(endpoint, options) {
        const headers = { 'Content-Type': 'application/json' };
        if (this.tg.initData) headers['X-TG-Init-Data'] = this.tg.initData;

        const res = await fetch(endpoint, {
          ...options,
          headers: { ...headers, ...(options?.headers || {}) },
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || `ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°: ${res.status}`);
        }
        return res.json();
      }

      async verifyUser() {
        const userData = await this.fetchAPI('/web/me');
        this.state.hasPhone = !!userData.has_phone;
        return { client_id: userData.id };
      }

      /* â”€â”€ Navigation â”€â”€ */

      hideLoading() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
      }

      showInitError(message) {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('error-screen').classList.remove('hidden');
        document.getElementById('init-error-message').textContent = message;
      }

      renderProgressBar() {
        const bar = document.getElementById('progress-bar');
        bar.innerHTML = this.steps
          .map((_, i) => `<div class="progress-step" data-step="${i + 1}"></div>`)
          .join('');
      }

      showStep(step) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step-${step}`).classList.add('active');

        const idx = this.steps.indexOf(step);
        document.querySelectorAll('.progress-step').forEach((el, i) => {
          el.classList.remove('completed', 'active');
          if (i < idx) el.classList.add('completed');
          else if (i === idx) el.classList.add('active');
        });

        step === 'service' ? this.tg.BackButton.hide() : this.tg.BackButton.show();
        this.updateMainButton(step);
        this.currentStep = step;
      }

      updateMainButton(step) {
        if (this.mainButtonCallback) {
          this.tg.MainButton.offClick(this.mainButtonCallback);
          this.mainButtonCallback = null;
        }
        this.tg.MainButton.hide();
      }

      handleBack() {
        this.tg.HapticFeedback.selectionChanged();
        const idx = this.steps.indexOf(this.currentStep);
        if (idx > 0) this.showStep(this.steps[idx - 1]);
      }

      /* â”€â”€ Step 1: Services â”€â”€ */

      renderServices() {
        const container = document.getElementById('services-list');
        container.innerHTML = this.services.map(s => {
          const icon = s.icon || 'â—ˆ';
          const range = this.priceRange(s.variants);
          return `
            <div class="service-card" data-id="${s.id}">
              <div class="service-card-icon">${icon}</div>
              <div class="service-card-body">
                <div class="service-card-name">${this.esc(s.name)}</div>
                ${s.description ? `<div class="service-card-desc">${this.esc(s.description)}</div>` : ''}
                <div class="service-card-meta">
                  <span>${range}</span>
                </div>
              </div>
              <div class="service-card-price">${s.duration_min} Ğ¼Ğ¸Ğ½</div>
            </div>
          `;
        }).join('');

        container.addEventListener('click', e => {
          const card = e.target.closest('.service-card');
          if (card) this.selectService(parseInt(card.dataset.id));
        });
      }

      async selectService(id) {
        const service = this.services.find(s => s.id === id);
        if (!service) return;
        this.tg.HapticFeedback.selectionChanged();
        this.state.service = service;

        document.querySelectorAll('.service-card').forEach(el => {
          el.classList.toggle('selected', el.dataset.id === String(id));
        });

        await this.loadCalendar();
      }

      /* â”€â”€ Step 2: Calendar â”€â”€ */

      async loadCalendar() {
        if (!this.state.service) return;
        try {
          const data = await this.fetchAPI(
            `/web/slots/calendar?location_id=${this.state.locationId}&service_id=${this.state.service.id}`
          );
          this.availableDays.clear();
          for (const day of data.days) this.availableDays.set(day.date, day.has_slots);

          const first = data.days.find(d => d.has_slots);
          if (first) this.currentMonth = new Date(first.date);

          this.renderCalendar();
          this.showStep('calendar');
        } catch (e) {
          console.error('Calendar load failed:', e);
          this.tg.HapticFeedback.notificationOccurred('error');
        }
      }

      renderCalendar() {
        const container = document.getElementById('calendar-days');
        const monthDisplay = document.getElementById('current-month');

        const year = this.currentMonth.getFullYear();
        const month = this.currentMonth.getMonth();

        const names = ['Ğ¯Ğ½Ğ²Ğ°Ñ€ÑŒ','Ğ¤ĞµĞ²Ñ€Ğ°Ğ»ÑŒ','ĞœĞ°Ñ€Ñ‚','ĞĞ¿Ñ€ĞµĞ»ÑŒ','ĞœĞ°Ğ¹','Ğ˜ÑĞ½ÑŒ',
                       'Ğ˜ÑĞ»ÑŒ','ĞĞ²Ğ³ÑƒÑÑ‚','Ğ¡ĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ','ĞĞºÑ‚ÑĞ±Ñ€ÑŒ','ĞĞ¾ÑĞ±Ñ€ÑŒ','Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ'];
        monthDisplay.textContent = `${names[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startOffset = (firstDay.getDay() + 6) % 7;
        const today = new Date(); today.setHours(0,0,0,0);

        // Nav limits: no past months, max 3 months ahead (year-safe)
        const cur = year * 12 + month;
        const min = today.getFullYear() * 12 + today.getMonth();
        const max = min + 3;
        document.getElementById('prev-month').disabled = cur <= min;
        document.getElementById('next-month').disabled = cur >= max;

        let html = '';
        for (let i = 0; i < startOffset; i++) html += '<div class="calendar-day empty"></div>';

        for (let d = 1; d <= lastDay.getDate(); d++) {
          const date = new Date(year, month, d);
          const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const isPast = date < today;
          const avail = !isPast && this.availableDays.get(iso);
          const isToday = date.getTime() === today.getTime();
          const isSelected = iso === this.state.date;

          const cls = ['calendar-day'];
          if (isToday) cls.push('today');
          if (isSelected) cls.push('selected');
          if (avail) cls.push('available');
          else cls.push('unavailable');

          html += `<div class="${cls.join(' ')}" data-date="${iso}">${d}</div>`;
        }

        container.innerHTML = html;
        container.onclick = e => {
          const el = e.target.closest('.calendar-day');
          if (el?.classList.contains('available')) this.selectDate(el.dataset.date);
        };

        document.getElementById('prev-month').onclick = () => this.navigateMonth(-1);
        document.getElementById('next-month').onclick = () => this.navigateMonth(1);

        // Init swipe once
        if (!this._swipeReady) {
          this._swipeReady = true;
          this.initCalendarSwipe();
        }
      }

      navigateMonth(dir) {
        if (this._navigating) return;
        const btn = document.getElementById(dir > 0 ? 'next-month' : 'prev-month');
        if (btn?.disabled) return;

        this._navigating = true;
        const grid = document.getElementById('calendar-days');
        grid.classList.add('calendar-swipe', dir > 0 ? 'swipe-left' : 'swipe-right');

        setTimeout(() => {
          this.currentMonth.setMonth(this.currentMonth.getMonth() + dir);
          this.renderCalendar();
          grid.classList.remove('calendar-swipe', 'swipe-left', 'swipe-right');
          this._navigating = false;
        }, 250);
      }

      initCalendarSwipe() {
        const el = document.getElementById('step-calendar');
        let startX = 0, startY = 0;

        el.addEventListener('touchstart', e => {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        }, { passive: true });

        el.addEventListener('touchend', e => {
          const dx = e.changedTouches[0].clientX - startX;
          const dy = e.changedTouches[0].clientY - startY;
          if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy) * 2) {
            this.navigateMonth(dx < 0 ? 1 : -1);
          }
        }, { passive: true });
      }

      async selectDate(date) {
        this.tg.HapticFeedback.selectionChanged();
        this.state.date = date;
        document.querySelectorAll('.calendar-day').forEach(el => {
          el.classList.toggle('selected', el.dataset.date === date);
        });
        await this.loadTimeSlots();
      }

      /* â”€â”€ Step 3: Time Slots â”€â”€ */

      async loadTimeSlots() {
        if (!this.state.service) return;

        // Show skeleton
        document.getElementById('time-skeleton').classList.remove('hidden');
        document.getElementById('time-slots-container').innerHTML = '';
        document.getElementById('no-slots-message').classList.add('hidden');

        this.showStep('time');

        const d = new Date(this.state.date);
        document.getElementById('selected-date-display').textContent =
          d.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });

        try {
          const svcParam = this.state.service.service_package_id
            ? `service_package_id=${this.state.service.service_package_id}`
            : `service_id=${this.state.service.id}`;
          const data = await this.fetchAPI(
            `/web/slots/day?location_id=${this.state.locationId}&${svcParam}&date=${this.state.date}`
          );
          this.timeSlots = data.slots || [];
          document.getElementById('time-skeleton').classList.add('hidden');
          this.renderTimeSlots();
        } catch (e) {
          console.error('Time slots load failed:', e);
          document.getElementById('time-skeleton').classList.add('hidden');
          this.tg.HapticFeedback.notificationOccurred('error');
        }
      }

      renderTimeSlots() {
        const container = document.getElementById('time-slots-container');
        const noMsg = document.getElementById('no-slots-message');

        if (this.timeSlots.length === 0) {
          container.innerHTML = '';
          noMsg.classList.remove('hidden');
          return;
        }
        noMsg.classList.add('hidden');

        // Group by period
        const groups = { morning: [], afternoon: [], evening: [] };
        const labels = { morning: 'Ğ£Ñ‚Ñ€Ğ¾', afternoon: 'Ğ”ĞµĞ½ÑŒ', evening: 'Ğ’ĞµÑ‡ĞµÑ€' };

        for (const s of this.timeSlots) {
          const h = parseInt(s.time.split(':')[0]);
          if (h < 12) groups.morning.push(s);
          else if (h < 17) groups.afternoon.push(s);
          else groups.evening.push(s);
        }

        let html = '';
        for (const [key, slots] of Object.entries(groups)) {
          if (slots.length === 0) continue;
          html += `
            <div class="time-group">
              <div class="time-group-label">${labels[key]}</div>
              <div class="time-slots-grid">
                ${slots.map(s => `<div class="time-slot" data-time="${s.time}">${s.time}</div>`).join('')}
              </div>
            </div>
          `;
        }
        container.innerHTML = html;

        container.onclick = e => {
          const el = e.target.closest('.time-slot');
          if (el) this.selectTime(el.dataset.time);
        };
      }

      async selectTime(time) {
        this.tg.HapticFeedback.selectionChanged();
        const slot = this.timeSlots.find(s => s.time === time);
        if (!slot) return;

        this.state.time = time;
        this.specialists = slot.specialists || [];

        document.querySelectorAll('.time-slot').forEach(el => {
          el.classList.toggle('selected', el.dataset.time === time);
        });

        // Decide: specialist step or straight to confirm
        if (this.specialists.length > 1) {
          this.hasMultipleSpecialists = true;
          this.steps = ['service', 'calendar', 'time', 'specialist', 'confirm'];
          this.renderProgressBar();
          this.renderSpecialists();
          this.showStep('specialist');
        } else {
          // Auto-select the only specialist (or first available)
          if (this.specialists.length === 1) {
            this.state.specialistId = this.specialists[0].id;
            this.state.specialistName = this.specialists[0].name || '';
          }
          this.hasMultipleSpecialists = false;
          this.steps = ['service', 'calendar', 'time', 'confirm'];
          this.renderProgressBar();
          this.showConfirmation();
        }
      }

      /* â”€â”€ Step 4: Specialist â”€â”€ */

      renderSpecialists() {
        const container = document.getElementById('specialists-list');
        const subtitle = document.getElementById('specialist-subtitle');
        subtitle.textContent = `${this.state.service.name} Â· ${this.state.time}`;

        container.innerHTML = this.specialists.map(sp => {
          const initials = (sp.name || 'Ğ¡')
            .split(' ')
            .map(w => w[0])
            .join('')
            .toUpperCase()
            .slice(0, 2);

          return `
            <div class="specialist-card" data-id="${sp.id}">
              <div class="specialist-avatar">
                ${sp.photo_url
                  ? `<img src="${this.esc(sp.photo_url)}" alt="${this.esc(sp.name)}">`
                  : initials
                }
              </div>
              <div class="specialist-body">
                <div class="specialist-name">${this.esc(sp.name || 'Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚')}</div>
                ${sp.role ? `<div class="specialist-role">${this.esc(sp.role)}</div>` : ''}
              </div>
              <div class="specialist-check">âœ“</div>
            </div>
          `;
        }).join('');

        container.onclick = e => {
          const card = e.target.closest('.specialist-card');
          if (card) this.selectSpecialist(parseInt(card.dataset.id));
        };
      }

      selectSpecialist(id) {
        const sp = this.specialists.find(s => s.id === id);
        if (!sp) return;
        this.tg.HapticFeedback.selectionChanged();

        this.state.specialistId = sp.id;
        this.state.specialistName = sp.name || '';

        document.querySelectorAll('.specialist-card').forEach(el => {
          el.classList.toggle('selected', el.dataset.id === String(id));
        });

        // Auto-advance to confirm after short delay
        setTimeout(() => this.showConfirmation(), 250);
      }

      /* â”€â”€ Step 5: Confirmation â”€â”€ */

      showConfirmation() {
        const details = document.getElementById('confirm-details');
        const d = new Date(this.state.date);
        const dateStr = d.toLocaleDateString('ru-RU', {
          weekday: 'short', day: 'numeric', month: 'long',
        });

        let rows = `
          <div class="confirm-row">
            <span class="confirm-label">Ğ£ÑĞ»ÑƒĞ³Ğ°</span>
            <span class="confirm-value">${this.esc(this.state.service.name)}</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">Ğ”Ğ°Ñ‚Ğ°</span>
            <span class="confirm-value">${dateStr}</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">Ğ’Ñ€ĞµĞ¼Ñ</span>
            <span class="confirm-value">${this.state.time}</span>
          </div>
        `;

        if (this.state.specialistName) {
          rows += `
            <div class="confirm-row">
              <span class="confirm-label">Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚</span>
              <span class="confirm-value">${this.esc(this.state.specialistName)}</span>
            </div>
          `;
        }

        rows += `
          <div class="confirm-row">
            <span class="confirm-label">Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ</span>
            <span class="confirm-value">${this.fmtPrice(this.state.service.price)}</span>
          </div>
        `;

        details.innerHTML = rows;

        // Show review, hide statuses
        document.getElementById('confirm-review').classList.remove('hidden');
        document.getElementById('status-pending').classList.add('hidden');
        document.getElementById('status-success').classList.add('hidden');
        document.getElementById('status-error').classList.add('hidden');

        const btn = document.getElementById('confirm-btn');
        btn.disabled = false;
        btn.textContent = 'Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ';
        btn.onclick = () => this.createBooking();

        this.showStep('confirm');
      }

      /* â”€â”€ Phone gate â”€â”€ */

      showToast(text, duration = 3000) {
        return new Promise((resolve) => {
          const el = document.createElement('div');
          el.className = 'phone-toast';
          el.innerHTML = `
            <div class="phone-toast-content">
              <div class="phone-toast-icon">ğŸ“±</div>
              <div class="phone-toast-text">${this.esc(text)}</div>
            </div>
          `;
          document.body.appendChild(el);
          setTimeout(() => {
            el.classList.add('fade-out');
            el.addEventListener('animationend', () => { el.remove(); resolve(); });
          }, duration);
        });
      }

      async ensurePhone() {
        if (this.state.hasPhone) return true;
        if (!this.tg.isVersionAtLeast?.('6.9')) return true; // old client, skip

        await this.showToast('Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°', 3000);

        return new Promise((resolve) => {
          this.tg.requestContact((ok, event) => {
            if (!ok) { resolve(false); return; }
            const phone = event?.responseUnsafe?.contact?.phone_number;
            if (!phone) { resolve(true); return; }
            this.fetchAPI('/web/me/phone', {
              method: 'POST',
              body: JSON.stringify({ phone }),
            }).then(() => {
              this.state.hasPhone = true;
              resolve(true);
            }).catch(() => resolve(true));
          });
        });
      }

      /* â”€â”€ Booking â”€â”€ */

      async createBooking() {
        if (!this.state.service || !this.state.specialistId) {
          this.showError('ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ.');
          return;
        }

        // Request phone if not on file (soft gate â€” decline doesn't block)
        await this.ensurePhone();

        // Disable button, show pending
        const btn = document.getElementById('confirm-btn');
        btn.disabled = true;
        btn.textContent = 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°...';

        document.getElementById('confirm-review').classList.add('hidden');
        document.getElementById('status-pending').classList.remove('hidden');

        try {
          const start = new Date(`${this.state.date}T${this.state.time}:00`);
          const end = new Date(start.getTime() + this.state.service.duration_min * 60000);

          const fmt = (d) => {
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
          };

          const result = await this.fetchAPI('/web/bookings', {
            method: 'POST',
            body: JSON.stringify({
              company_id: 1,
              location_id: this.state.locationId,
              service_id: this.state.service.id,
              client_id: this.state.clientId,
              specialist_id: this.state.specialistId,
              date_start: fmt(start),
              date_end: fmt(end),
              duration_minutes: this.state.service.duration_min,
              break_minutes: this.state.service.break_min || 0,
            }),
          });

          this.tg.HapticFeedback.notificationOccurred('success');
          this.showSuccess(result.id);
        } catch (e) {
          console.error('Booking failed:', e);
          this.tg.HapticFeedback.notificationOccurred('error');
          this.showError(e.message || 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°');
        }
      }

      showSuccess(bookingId) {
        document.getElementById('status-pending').classList.add('hidden');
        document.getElementById('status-error').classList.add('hidden');
        document.getElementById('status-success').classList.remove('hidden');

        const summary = document.getElementById('booking-summary');
        if (summary && this.state.service) {
          const d = new Date(this.state.date);
          let rows = `
            <div class="summary-row">
              <span class="summary-label">Ğ£ÑĞ»ÑƒĞ³Ğ°</span>
              <span class="summary-value">${this.esc(this.state.service.name)}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Ğ”Ğ°Ñ‚Ğ°</span>
              <span class="summary-value">${d.toLocaleDateString('ru-RU')}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Ğ’Ñ€ĞµĞ¼Ñ</span>
              <span class="summary-value">${this.state.time}</span>
            </div>
          `;
          if (this.state.specialistName) {
            rows += `
              <div class="summary-row">
                <span class="summary-label">Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚</span>
                <span class="summary-value">${this.esc(this.state.specialistName)}</span>
              </div>
            `;
          }
          rows += `
            <div class="summary-row">
              <span class="summary-label">Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ</span>
              <span class="summary-value">${this.fmtPrice(this.state.service.price)}</span>
            </div>
          `;
          summary.innerHTML = rows;
        }

        // Block back navigation after success
        this.tg.BackButton.hide();

        this.tg.MainButton.text = 'Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ';
        this.tg.MainButton.show();
        this.mainButtonCallback = () => this.tg.close();
        this.tg.MainButton.onClick(this.mainButtonCallback);
      }

      showError(message) {
        document.getElementById('status-pending').classList.add('hidden');
        document.getElementById('status-success').classList.add('hidden');
        document.getElementById('confirm-review').classList.add('hidden');
        document.getElementById('status-error').classList.remove('hidden');
        document.getElementById('error-message').textContent = message;

        this.tg.MainButton.text = 'ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°';
        this.tg.MainButton.show();
        this.mainButtonCallback = () => {
          // Return to time selection, not confirm â€” avoids double booking
          this.showStep('time');
        };
        this.tg.MainButton.onClick(this.mainButtonCallback);
      }

      /* â”€â”€ Helpers â”€â”€ */

      esc(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
      }

      fmtPrice(price) {
        return new Intl.NumberFormat('ru-RU', {
          style: 'currency', currency: 'RUB', minimumFractionDigits: 0,
        }).format(price);
      }

      priceRange(variants) {
        if (!variants || variants.length === 0) return '';
        const sorted = [...variants].sort((a, b) => b.qty - a.qty);
        const min = sorted[0].per_session ?? sorted[0].price;
        const single = variants.find(v => v.qty === 1);
        const max = single ? single.price : min;
        const fmt = n => Math.round(n).toLocaleString('ru-RU');
        if (min === max) return `${fmt(min)} â‚½`;
        return `Ğ¾Ñ‚ ${fmt(min)} Ğ´Ğ¾ ${fmt(max)} â‚½`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => new MiniApp());
  </script>
</body>
</html>
